# 开发日志/想法

## 1.记忆功能

你提到的两种记忆模式，在架构设计上可以这样实现：

1. **一直记忆 (Global Context / System Prompt)**：
   - **原理：** 把记忆写在一个固定的文件（如 `global.txt`）里。每次程序启动或每一轮对话时，程序会自动读取这个文件的内容，拼接到 System Prompt（系统提示词）里。
   - **效果：** AI 永远记得（比如：“我叫张三，喜欢 Python，讨厌 Java”）。
2. **调用记忆 (On-Demand / RAG Lite)**：
   - **原理：** 把记忆存为独立的小文件（如 `project_alpha.txt`, `api_docs.txt`）。AI 只有在需要的时候，通过调用 `read_memory` 工具去读取。
   - **效果：** 节省 Token，只有聊到特定话题时才加载相关记忆。

---

## 2. P0 + P4 优化（2026-02-12）

### P0: 核心能力补齐

| 功能 | 文件 | 说明 |
|------|------|------|
| `run_command` | `skills/shell_tools.py` | Shell 命令执行，支持超时、输出截断 |
| `list_dir` | `skills/shell_tools.py` | 目录浏览，支持条目限制 |

- 两个工具均已注册到 `skills/__init__.py`
- `run_command` 已加入 `RISKY_TOOLS`，执行前需用户审批

### P4: 安全与体验

**run_command 沙箱化（`skills/shell_tools.py`）：**
- 14 条危险命令正则黑名单：拦截 `rm -rf`、`format`、`del /s`、`shutdown`、`curl | bash` 等
- 6 条禁止目录：`C:\Windows`、`C:\Program Files`、`/etc`、`/usr`、`/boot`、`/sys`
- `_is_command_safe()` 在执行前自动校验，不安全直接返回拒绝

**Rich 终端美化（`core/ui.py`）：**
- AI 回复：`Panel` + `Markdown` 渲染，青色边框
- 欢迎界面：`Table` 面板，显示已加载技能数
- 审批界面：红色 `Panel`，结构化展示参数
- 代码查看：`Syntax` 语法高亮 + 行号
- 所有 `print()` 替换为 `console.print()`

**其他：**
- 创建 `requirements.txt`（openai, python-dotenv, psutil, rich, chromadb）
- 创建 `.gitignore`（保护 .env、venv/、__pycache__/ 等）
- `write_code_file` 安全检查增强：保护 config.py、engine.py 等核心文件

---

## 3. P1: 代码编辑增强（2026-02-12）

### 精确编辑工具 edit_file（`skills/edit_tools.py`）

**问题：** `write_code_file` 只能整文件覆盖，修 Bug 时容易丢失原有代码。

**方案：** 实现 find & replace 模式：
- 输入 `old_text`（要替换的原文）+ `new_text`（新文本）
- 唯一性校验：`old_text` 在文件中必须恰好出现 1 次，多处匹配则拒绝执行
- 自动生成 unified diff 作为返回结果
- 同样有核心文件保护列表

**设计决策：**
- 为什么要求唯一匹配？→ 防止意外改错位置。AI 需要提供足够的上下文让匹配唯一。
- 为什么不用行号？→ 行号在多次编辑后会漂移，文本匹配更稳定。

### Diff 预览（`core/ui.py`）

- 审批面板对 `edit_file` 特殊处理：展示替换字符数摘要
- 输入 `v` 时用 `difflib.unified_diff` 生成 diff，通过 `rich.syntax.Syntax` 语法高亮展示

---

## 4. P2: Agent 能力增强（2026-02-12）

### 多步规划 Planning（`skills/plan_tools.py`）

**问题：** AI 遇到复杂任务时容易"东一榔头西一棒"，没有系统性。

**方案：**
- `create_plan(task, steps)` → 创建带步骤的执行计划
- `update_plan(step_index, status, note)` → 标记步骤完成/失败/跳过
- 内存级存储，带进度渲染（✅⬜❌⏭️）
- System Prompt 增加引导："复杂任务先调用 create_plan 制定计划"

### 错误重试机制（`core/engine.py`）

**问题：** 工具执行偶尔失败（网络抖动、文件锁等），直接返回错误给 AI 导致对话质量下降。

**方案：**
- `MAX_TOOL_RETRIES = 3`：工具异常时自动重试，间隔 0.5s
- `MAX_AGENT_STEPS = 15`：单次对话最大 Agent 循环步数，防止死循环
- UI 显示重试进度

### Streaming 流式输出（`core/engine.py` + `core/ui.py`）

**问题：** 之前等 AI 完整回复才显示，用户体验差（长时间空白）。

**方案：**
- `stream_chat()` 函数：使用 OpenAI `stream=True` 模式
- 文本内容逐 token 输出到终端（`ui.stream_token()`）
- 工具调用部分在后台静默收集，不影响流式体验
- 结束后自动换行（`ui.stream_end()`）

**技术细节：** 流式模式下 tool_calls 是分片到达的，需要按 `tc.index` 索引收集，拼接 `arguments` 字符串后再 JSON 解析。

---

## 5. P3: 记忆与上下文（2026-02-12）

### 向量检索记忆 RAG（`skills/rag_tools.py`）

**问题：** 原有记忆系统 (`memory_tools.py`) 是纯文件名匹配，必须知道精确的 topic_name 才能检索。

**方案：** 基于 chromadb 的语义搜索：
- `rag_save(content, tags)` → 存入向量数据库，支持标签
- `rag_search(query, top_k)` → 自然语言查询，按 cosine 相似度返回
- `rag_status()` → 查看记忆库统计
- 持久化存储在 `memories/chroma_db/`
- 使用 chromadb 内置的 embedding 模型（默认 all-MiniLM-L6-v2）

**与旧记忆系统的关系：**
- `memory_tools.py`（旧）保留 → 适合精确的全局记忆和按话题归档
- `rag_tools.py`（新）→ 适合模糊搜索、项目笔记、零散知识

### 对话持久化（`core/engine.py`）

**问题：** 每次退出后对话上下文全部丢失。

**方案：**
- `save_chat_history(messages)` → 退出时 / 每轮对话后自动保存到 `memories/chat_history/latest.json`
- `load_chat_history()` → 启动时检测并询问是否恢复
- 序列化处理：兼容 OpenAI message 对象和普通 dict
- 上下文裁剪在恢复后仍然生效

---

## 6. 大版本更新：完整功能对齐 + 多领域扩展（2026-02-14）

本次更新将技能从 16 个扩展到 **48 个**，覆盖三大方向。

### 6.1 Task1: 代码编辑与文件管理对齐 Claude Code

**新增编辑工具（`skills/edit_tools.py` 扩展）：**
- `insert_text` — 按行号插入文本（行号 0=开头，-1=末尾）
- `delete_lines` — 删除指定行范围
- `multi_edit` — 单文件多处 find & replace，批量编辑

**新增文件管理（`skills/file_manager.py`）：**
- `create_file` — 创建新文件，自动建父目录，已存在则拒绝覆盖
- `delete_file` — 删除文件/目录，非空目录需 `recursive=true`
- `copy_file` — 复制文件/目录
- `rename_file` — 重命名/移动
- `get_file_info` — 获取文件元信息（大小、行数、修改时间、编码）

**新增搜索工具（`skills/grep_tools.py`）：**
- `grep` — 全文正则搜索，支持文件过滤、上下文行数、大小写控制
- `tree` — 目录树可视化，支持深度限制和 glob 过滤

**设计决策：**
- 所有文件修改类工具均有核心文件保护（PROTECTED_FILES）
- 新工具全部加入 RISKY_TOOLS，需用户审批
- `grep` 内置 60+ 种文本文件扩展名识别，自动忽略 .git/venv 等

### 6.2 Task2: 多领域功能扩展

**外部 AI API 接口（`skills/external_ai.py`）：**
- `call_ai` — 统一调用 6 个 AI 提供商（Kimi/OpenAI/DeepSeek/Claude/智谱/通义千问）
- `list_ai_providers` — 查看已配置的提供商和 API Key 状态
- 通过 .env 配置对应 Key 即可启用，无需改代码

**网络搜索与抓取（`skills/web_tools.py`）：**
- `fetch_url` — 抓取网页内容，自动 HTML→纯文本转换
- `web_search` — 多引擎搜索（Serper/Bing/DuckDuckGo），自动降级

**翻译与文献阅读（`skills/doc_tools.py`）：**
- `translate` — AI 翻译，支持 4 种风格（直译/意译/学术/口语）
- `read_pdf` — PDF 文本提取（PyPDF2），支持分页读取
- `summarize_document` — 文档 AI 摘要（简要/详细/大纲/要点 4 种模式）

**日常信息管理（`skills/daily_tools.py`）：**
- `todo_manage` — 待办事项 CRUD + 优先级 + 分类
- `note_manage` — Markdown 笔记管理（创建/追加/搜索/删除）
- `reminder_manage` — 提醒事项管理 + 到期检查

**视频工具（`skills/video_tools.py`）：**
- `video_info` — 视频元信息（FFprobe）
- `video_transcript` — 字幕提取（内嵌/外部/YouTube/Whisper 4 种方式）
- `video_summary` — 视频 AI 总结（字幕→AI 摘要）
- `video_clip` — FFmpeg 视频剪辑接口

**知识库（`skills/knowledge_tools.py`）：**
- `kb_build` — 从文件/目录构建向量知识库（chromadb），自动分块
- `kb_query` — 语义搜索知识库
- `kb_manage` — 知识库管理（列出/状态/删除）

**PPT 生成（`skills/ppt_tools.py`）：**
- `ppt_generate` — 根据大纲数据生成 PPTX（python-pptx）
- `ppt_outline` — AI 自动生成 PPT 大纲 JSON

### 6.3 Task3: 社交信息流处理（OpenClaw-like）

**社交工具（`skills/social_tools.py`）：**
- `rss_manage` — RSS/Atom 订阅管理 + 内容抓取（无依赖，内置 XML 解析）
- `feed_digest` — 信息流 AI 摘要（每日简报/精选/深度分析 3 种模式）
- `social_connector` — 6 大社交平台 API 接口框架：
  - 微博、Twitter/X、微信公众号、Telegram、GitHub、Reddit
  - GitHub 已实现完整搜索和通知功能
  - 其他平台为接口预留，配置 API Key 后可扩展

---

## 7. 技能总览（48 个）

### 核心编辑与文件

| # | 技能名 | 文件 | 说明 | 审批 |
|---|--------|------|------|------|
| 1 | `edit_file` | edit_tools.py | 精确 find & replace | ✅ |
| 2 | `insert_text` | edit_tools.py | 按行号插入 | ✅ |
| 3 | `delete_lines` | edit_tools.py | 删除行范围 | ✅ |
| 4 | `multi_edit` | edit_tools.py | 批量编辑 | ✅ |
| 5 | `write_code_file` | code_tools.py | 整文件写入 | ✅ |
| 6 | `read_file` | read_files.py | 读取文件 | - |
| 7 | `create_file` | file_manager.py | 创建新文件 | ✅ |
| 8 | `delete_file` | file_manager.py | 删除文件/目录 | ✅ |
| 9 | `copy_file` | file_manager.py | 复制 | - |
| 10 | `rename_file` | file_manager.py | 重命名/移动 | ✅ |
| 11 | `get_file_info` | file_manager.py | 文件详情 | - |
| 12 | `move_file_by_ext` | file_tools.py | 按扩展名移动 | ✅ |

### 搜索与导航

| # | 技能名 | 文件 | 说明 |
|---|--------|------|------|
| 13 | `find_file` | search_tools.py | 按文件名搜索 |
| 14 | `grep` | grep_tools.py | 全文正则搜索 |
| 15 | `tree` | grep_tools.py | 目录树视图 |
| 16 | `list_dir` | shell_tools.py | 列出目录内容 |

### 系统与Shell

| # | 技能名 | 文件 | 说明 | 审批 |
|---|--------|------|------|------|
| 17 | `run_command` | shell_tools.py | Shell 命令执行 | ✅ |
| 18 | `get_system_status` | system_tools.py | CPU/内存使用 | - |

### 规划与记忆

| # | 技能名 | 文件 | 说明 |
|---|--------|------|------|
| 19 | `create_plan` | plan_tools.py | 创建执行计划 |
| 20 | `update_plan` | plan_tools.py | 更新计划进度 |
| 21 | `save_memory` | memory_tools.py | 保存记忆 |
| 22 | `read_memory` | memory_tools.py | 读取记忆 |
| 23 | `list_memories` | memory_tools.py | 列出记忆 |
| 24 | `rag_save` | rag_tools.py | 语义存储 |
| 25 | `rag_search` | rag_tools.py | 语义搜索 |
| 26 | `rag_status` | rag_tools.py | 记忆库状态 |

### 外部 AI & 网络

| # | 技能名 | 文件 | 说明 |
|---|--------|------|------|
| 27 | `call_ai` | external_ai.py | 调用外部 AI |
| 28 | `list_ai_providers` | external_ai.py | 列出 AI 提供商 |
| 29 | `fetch_url` | web_tools.py | 抓取网页 |
| 30 | `web_search` | web_tools.py | 网络搜索 |

### 翻译与文献

| # | 技能名 | 文件 | 说明 |
|---|--------|------|------|
| 31 | `translate` | doc_tools.py | AI 翻译 |
| 32 | `read_pdf` | doc_tools.py | PDF 读取 |
| 33 | `summarize_document` | doc_tools.py | 文档摘要 |

### 日常管理

| # | 技能名 | 文件 | 说明 |
|---|--------|------|------|
| 34 | `todo_manage` | daily_tools.py | 待办事项 |
| 35 | `note_manage` | daily_tools.py | 笔记管理 |
| 36 | `reminder_manage` | daily_tools.py | 提醒管理 |

### 视频处理

| # | 技能名 | 文件 | 说明 | 审批 |
|---|--------|------|------|------|
| 37 | `video_info` | video_tools.py | 视频信息 | - |
| 38 | `video_transcript` | video_tools.py | 字幕提取 | - |
| 39 | `video_summary` | video_tools.py | 视频总结 | - |
| 40 | `video_clip` | video_tools.py | 视频剪辑 | ✅ |

### 知识库

| # | 技能名 | 文件 | 说明 |
|---|--------|------|------|
| 41 | `kb_build` | knowledge_tools.py | 构建知识库 |
| 42 | `kb_query` | knowledge_tools.py | 查询知识库 |
| 43 | `kb_manage` | knowledge_tools.py | 管理知识库 |

### PPT 生成

| # | 技能名 | 文件 | 说明 |
|---|--------|------|------|
| 44 | `ppt_generate` | ppt_tools.py | 生成 PPTX |
| 45 | `ppt_outline` | ppt_tools.py | AI 大纲生成 |

### 社交信息流

| # | 技能名 | 文件 | 说明 |
|---|--------|------|------|
| 46 | `rss_manage` | social_tools.py | RSS 订阅管理 |
| 47 | `feed_digest` | social_tools.py | 信息流 AI 摘要 |
| 48 | `social_connector` | social_tools.py | 社交平台连接器 |
